<!DOCTYPE html>
<html>
<head lang="en">
	<meta charset="UTF-8">
	<title>static wrap</title>
<script>
	document.addEventListener("DOMContentLoaded", function (event) {
		if (!window.FileReader) return;

		var drop = document.querySelector("#drop");

		drop.addEventListener("dragenter", function (event) {
			this.classList.add("over");
		}, false);
		drop.addEventListener("dragleave", function (event) {
			this.classList.remove("over");
		}, false);
		drop.addEventListener("dragover", function (event) {
			event.stopPropagation();
			event.preventDefault();
		}, false);
		drop.addEventListener("drop", function (event) {
			event.stopPropagation();
			event.preventDefault();

			this.classList.remove("over");

			clear();
			processDropped(event.dataTransfer.files);
		}, false);

		var output = document.querySelector("#output");

		function clear() {
			while (output.children.length) {
				output.removeChild(output.children[0]);
			}
		}

		function processDropped(files) {
			for (var i = 0; i < files.length; i++) {
				var file = files[i];
				if (/^image\//.test(file.type)) {
					imageFromFile(file).then(decorateImage).then(function (decorated) {
						output.appendChild(decorated);
						return canvasForDom(decorated);
					}).then(function (canvas) {
						output.appendChild(canvas);
					}).catch(function (err) {
						console.log('failed', err);
					});
				}
			}
		}

		function decorateImage(image) {
			var div = document.createElement("div");
			div.classList.add("decorated");
			div.appendChild(image);
			return div;
		}

		function imageFromFile(file) {
			return new Promise(function (resolve, reject) {
				var image = document.createElement("img");
				var reader = new FileReader();
				reader.onload = function (event) {
					image.src = event.target.result;
					resolve(image);
				};
				reader.readAsDataURL(file);
			});
		}

		function canvasForImage(image) {
			var canvas = document.createElement("canvas");
			canvas.width = image.width;
			canvas.height = image.height;
			var context = canvas.getContext("2d");
			context.drawImage(image, 0, 0, image.width, image.height);
			return canvas;
		}

		function svgForDom(element) {
			return new Promise(function (resolve, reject) {
				var width = element.offsetWidth;
				var height = element.offsetHeight;
				var data = '<svg xmlns="http://www.w3.org/2000/svg" width="' + width + '" height="' + height + '">' +
						'<foreignObject width="100%" height="100%">' +
						'<div xmlns="http://www.w3.org/1999/xhtml" style="font-size: 40px"><h1>HI!</h1>' +
						'</div>' +
						'</foreignObject>' +
						'</svg>';

				console.log('svg source', data);
				var image = document.createElement("img");
				var svg = new Blob([data], {type: "image/svg+xml;charset=utf-8"});
				var url = URL.createObjectURL(svg);
				image.onerror = reject;
				image.onload = function () {
					URL.revokeObjectURL(url);
					resolve(image);
				};
				image.src = url;
			});
		}

		function canvasForDom(element) {
			return svgForDom(element).then(function (image) {
				console.log('got svg', image);
				var canvas = document.createElement("canvas");
				canvas.width = element.offsetWidth;
				canvas.height = element.offsetHeight;
				var context = canvas.getContext("2d");
				context.drawImage(image, 0, 0);
				return canvas;
			});
		}
	});
</script>
<style>
	#settings {
		list-style: none;
		display: table;
		margin: 0 auto;
		padding: 0;
		text-align: center;
	}
	#settings li {
		display: table-cell;
		width: 30%;
	}
	#settings p {
		font-size: smaller;
		color: #666;
	}
	#drop {
		border-radius: 1em;
		border: 0.2em solid paleturquoise;
		display: inline-block;
		text-align: center;
		font-size: 3em;
		width: 1.5em;
		line-height: 1.5em;
		color: #999;
	}
	#drop.over {
		border-color: darkturquoise;
		color: #333;
	}
	#output {
		text-align: center;
	}
	#output::before {
		border: 1px solid #EEE;
		content: "";
		display: block;
		margin: 1em 5em;
	}
	#output > * {
		margin: 1em;
	}
	.decorated {
		display: inline-block;
		box-shadow: rgba(0, 0, 0, .3) 0 0 10px 1px;
		border-radius: 3px 3px 0 0;
	}
	.decorated > * {
		border-width: 0 1px 1px 1px;
		border-color: #999;
		border-style: solid;
		vertical-align: bottom;
	}
	.decorated::before {
		content: "";
		display: block;
		border-image-source: url(top.png);
		border-image-slice: 25 22 0 61;
		border-width: 25px 22px 0 61px;
		border-style: solid;
	}
</style>
</head>
<body>
	<ul id="settings">
		<li>
			<p>(drag & drop)</p>
			<div id="drop">&#8681;</div>
		</li>
	</ul>
	<div id="output">
	</div>
</body>
</html>